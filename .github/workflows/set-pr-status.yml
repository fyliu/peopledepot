name: Set PR Status After Board Assignment

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  set-status:
    runs-on: ubuntu-latest
    steps:
      - name: Wait until PR is added to a project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const desiredStatus = process.env.STATUS || "Needs Review";
            const prNodeId = context.payload.pull_request.node_id;

            const query = `
              query($prId: ID!) {
                node(id: $prId) {
                  ... on PullRequest {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                          fields(first: 20) {
                            nodes {
                              ... on ProjectV2SingleSelectField {
                                id
                                name
                                options { id name }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            // Poll until projectItems is non-empty (max 30s)
            let node = null;
            for (let i = 0; i < 30; i++) {
              const result = await github.graphql(query, { prId: prNodeId });
              node = result.node;
              if (node && node.projectItems.nodes.length > 0) {
                core.info("PR has been added to a project");
                break;
              }
              core.info("Waiting for board automation to add PR...");
              await new Promise(r => setTimeout(r, 2000));
            }

            if (!node || !node.projectItems.nodes.length) {
              core.warning("PR was never added to a project (timeout)");
              return;
            }

            for (const item of node.projectItems.nodes) {
              const statusField = item.project.fields.nodes.find(f => f.name === "Status");
              if (!statusField) {
                core.warning(`No "Status" field in project ${item.project.title}`);
                continue;
              }

              const option = statusField.options.find(o => o.name === desiredStatus);
              if (!option) {
                core.warning(`No "${desiredStatus}" option in project ${item.project.title}`);
                continue;
              }

              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: { singleSelectOptionId: $optionId }
                    }
                  ) {
                    projectV2Item { id }
                  }
                }
              `;

              await github.graphql(mutation, {
                projectId: item.project.id,
                itemId: item.id,
                fieldId: statusField.id,
                optionId: option.id
              });

              core.info(`âœ… Updated PR status in project "${item.project.title}" to "${desiredStatus}"`);
            }
        env:
          STATUS: PR Needs review (automated column, do not place items here manually)
